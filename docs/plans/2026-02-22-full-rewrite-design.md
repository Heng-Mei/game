# 全量重写设计文档（7 游戏统一重构）

## 1. 目标与范围

### 目标
- 彻底移除旧版 `legacy/iframe` 运行模式，不保留旧渲染路径。
- 以全新代码重建 7 个游戏：俄罗斯方块、贪吃蛇、扫雷、蜘蛛纸牌、小恐龙、Flappy Bird、2048。
- 首版优先保证规则准确、操作稳定、手机与桌面可玩性。
- 建立统一的日间/夜间现代扁平化视觉体系，覆盖大厅与游戏内 HUD。

### 浏览器范围
- 桌面端：Chrome / Edge（现代版本）
- 移动端：iOS Safari / Android Chrome（现代版本）

## 2. 技术选型与总体架构

### 选型结论
- 前端壳层：React + TypeScript + Vite
- 游戏运行层：Phaser 3
- 状态管理：Zustand（仅跨游戏状态）
- 测试：Vitest（规则层）+ Playwright（端到端）

### 架构分层
- React 壳层：路由、大厅、设置弹窗、主题切换、全局布局。
- Platform 运行层：统一 `GameHost`、输入抽象、尺寸与横竖屏策略、生命周期。
- Game 模块层：每个游戏拆成 `rules`（纯逻辑）+ `scene`（渲染与输入）+ `input-map` + `hud`。
- Contracts 层：统一游戏协议与类型契约，避免各游戏接口割裂。

## 3. 目录与模块边界

- `docs/src/app/*`：路由、页面骨架、错误边界与加载态。
- `docs/src/platform/*`：Phaser 宿主、输入系统、viewport/safe-area 适配。
- `docs/src/contracts/*`：`GameManifest`、`GameAction`、`GameSnapshot` 等。
- `docs/src/games/<game-id>/*`：每个游戏固定四件套：
  - `rules.ts`
  - `scene.ts`
  - `input-map.ts`
  - `hud.tsx`
- `docs/src/theme/*`：日间/夜间 token 和语义变量。
- `docs/src/state/*`：主题、语言、音量、最近游玩等跨游戏状态。
- `docs/tests/*`：规则单测与 e2e。

## 4. 交互与布局规范

### 全局交互原则
- 主画布优先完整可见；HUD 不挤占核心操作区。
- 仅保留一层菜单入口（React 路由层），杜绝“游戏内返回菜单套娃”。
- 文案统一中英双语，简介只写玩法目标，不出现开发术语。

### 桌面端
- 固定双栏：左画布、右 HUD。
- HUD 包含分数/状态/重开/暂停及各游戏必要信息。

### 移动端
- 默认轻 HUD，详细信息通过底部抽屉手动展开。
- 连点类（Flappy/Dino）优先“点击画布直接操作”，不强制额外按键。
- 方向类（Tetris/Snake/2048）支持虚拟键与手势策略。
- 扫雷/蜘蛛采用模式切换 + 手势，减少按钮堆叠。

### 横竖屏
- 不强制横屏。
- 竖屏保证画布完整与可操作；横屏提升信息密度与操作舒适度。

## 5. 数据流与容错

### 统一数据流
- 输入设备 -> 标准化 `Action` -> `rules` 计算 -> `scene` 渲染 -> HUD 同步。

### 容错要求
- 每个游戏支持暂停/继续、重开、局内设置即时生效。
- 切主题、后台恢复、旋转屏幕后当前对局不丢失（至少局内保持）。

## 6. 验收标准

### 功能验收
- 7 个游戏均可从大厅进入并完整游玩。
- 桌面与移动端均可完成核心操作流程。
- 主题切换对大厅与游戏内 HUD 同时生效。

### 测试验收
- 每个游戏规则层必须有单元测试覆盖关键规则与边界。
- e2e 覆盖：启动、切换游戏、核心输入、移动端触控、主题切换。
- 发布 smoke 覆盖：Pages 直达、刷新不白屏、横竖屏可玩。

## 7. 非目标（首版不做）

- 不追求首版完整高阶动效（规则稳定优先）。
- 不做旧浏览器广泛兼容。
- 不保留旧版 `legacy` 代码路径与 iframe 兼容层。
